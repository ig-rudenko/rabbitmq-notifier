## Настройка

### Создание сертификатов


Для работы библиотеки x509 необходимо настроить `subjectAltName`. Для этого добавьте в файл `/etc/ssl/openssl.conf`
блок `alt_names` где будут альтернативные домены. Обязательно укажите основной домен, так как subjectAltName
переопределяет полностью CN.

```ini
[ alt_names ]
DNS.1 = server1.example.com
DNS.2 = mail.example.com
DNS.3 = www.example.com
DNS.4 = www.sub.example.com
DNS.5 = mx.example.com
DNS.6 = support.example.com

[ v3_ca ]
# Подключаем
subjectAltName = @alt_names
...
```

Создать файлы сертификатов для сервера и клиента можно через скрипт `rabbit-settings/create-certs.sh`

```shell
bash rabbit-settings/create-certs.sh 'rabbitHost' 'rabbitUser';
```

Скрипт создаст 5 файлов:

- `server.key`: Этот файл содержит закрытый ключ (private key) сервера. 
    Этот ключ используется для подписания запроса на сертификат и для создания подписанного
    самоподписанного серверного сертификата.
- `server.crt`: Самоподписанный серверный сертификат. Этот файл содержит открытый ключ сервера,
    данные о сервере и подпись, сгенерированную закрытым ключом сервера. Он используется 
    сервером для установки защищенного соединения.
- `root.crt`: Корневой сертификат (cacert). В данном случае, этот файл представляет
    собой самоподписанный корневой сертификат, который используется для подписи клиентских сертификатов.
    Этот файл может быть распространен среди клиентов для проверки подлинности сервера.
- `client.key`: Закрытый ключ (private key) клиента. Этот ключ используется для создания 
    запроса на подпись сертификата клиента и для создания подписанного клиентского сертификата.
- `client.crt`: Подписанный клиентский сертификат. Этот файл содержит открытый ключ клиента, 
    данные о клиенте и подпись, сгенерированную закрытым ключом сервера (root key).

Для запуска rabbitmq будут необходимы `server.key`, `server.crt`, `root.crt`.

Для подключения клиента - `root.crt`, `client.key`, `client.crt`.

### Файл конфигурации

Для работы приложения требуется настроить файл конфигурации `config.json`.

Через переменную окружения `CONFIG_FILE` можно указать, где искать файл конфигурации,
по умолчанию - `/etc/rmq-notifier/config.json`

`expireAfterSeconds` указывает время в секундах спустя которое сообщения для consumer будут
пропущены и помечены как Acknowledge.


## Запуск

### Отправка через producer

Для запуска **producer** необходимо обязательно указать в файле конфигурации все значения для блока `rabbitmq` и `exchange`.

```shell
notifier producer tg '{"chatId":123123, "message":"hello", "parseMode":"MarkdownV2", "token":"672364"}'
```

- параметр `producer` запускает приложение для отправки сообщения;
- `tg` это routingKey, который будет указан в сообщении;
- последний параметр это тело сообщения в формате JSON. Для обработки далее этого сообщения через `consumer`.


### Обработка через consumer

Для запуска **consumer** должны быть указаны все значения в файле конфигурации


```shell
notifier consumer telegram
```

- параметр `consumer` запускает приложения для приема сообщений;
- `telegram` это тип уведомителя, который должен обработать сообщение.
Доступны: `telegram`, `sms`, `email`.

Для уведомителя `telegram` тело сообщения должно быть JSON в формате:

```json
{ 
  "chatId": 123123123,
  "message": "hello", 
  "parseMode": "MarkdownV2",
  "token": "****"
}
```

## Схема работы

![schema.png](docs/img/schema.png)